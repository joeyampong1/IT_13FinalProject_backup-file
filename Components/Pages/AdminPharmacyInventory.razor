@page "/admin-pharmacy-inventory"
@layout Layout.DashboardLayout
@using IT_13FinalProject.Models
@using IT_13FinalProject.Data
@using Microsoft.EntityFrameworkCore

@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject IJSRuntime JsRuntime

<div class="pm-page">
    <header class="dashboard-header">
        <div>
            <h1 class="dashboard-title">Pharmacy Inventory</h1>
            <p class="dashboard-subtitle">Welcome back Admin!</p>
        </div>

        <div class="dashboard-user-info">
            <span class="dashboard-user-email">admin@gmail.com</span>
            <div class="dashboard-user-avatar">U</div>
            <span class="dashboard-user-name">Admin</span>
        </div>
    </header>

    <section class="pm-overview">
        <div class="pm-overview-header">
            <h2 class="pm-section-title">Stocks Overview</h2>
            <div class="pm-show-entries">
                <span>Show</span>
                <select>
                    <option>5</option>
                    <option>10</option>
                    <option>25</option>
                </select>
                <span>entries</span>
            </div>
        </div>

        <div class="pm-filters-row">
            <div class="pm-search-row">
                <div class="pm-search-box">
                    <span class="pm-search-icon"></span>
                    <input class="pm-search-input" placeholder="Search Medicine" />
                </div>

                <div class="pm-actions">
                    <button class="activity-action-btn">Sort</button>
                    <button class="activity-action-btn">Filters</button>
                </div>
            </div>
        </div>

        <div class="pm-table-outer">
            <div class="pm-table-wrapper">
                <table class="pm-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Category</th>
                            <th>Stock</th>
                            <th>Value</th>
                            <th>Trend</th>
                            <th>Status</th>
                            <th class="pm-col-action">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (IsLoading)
                        {
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">
                                    <div>Loading inventory...</div>
                                </td>
                            </tr>
                        }
                        else if (!string.IsNullOrEmpty(ErrorMessage))
                        {
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">
                                    <div style="color: red;">Error: @ErrorMessage</div>
                                    <button class="pm-view-btn" @onclick="LoadInventory" style="margin-top: 1rem;">Retry</button>
                                </td>
                            </tr>
                        }
                        else if (Stocks.Count == 0)
                        {
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">
                                    <div>No inventory items found.</div>
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var s in Stocks)
                            {
                                <tr>
                                    <td>@s.Name</td>
                                    <td>@s.Category</td>
                                    <td>@s.Stock</td>
                                    <td>@s.Value</td>
                                    <td>@s.Trend</td>
                                    <td>
                                        <span class="ip-status-pill ip-status-@s.StatusKey">
                                            <span class="ip-status-dot"></span>
                                            <span>@s.StatusLabel</span>
                                        </span>
                                    </td>
                                    <td class="pm-col-action">
                                        <button class="pm-view-btn" aria-label="View stock item" @onclick="() => OpenItemDetails(s)">
                                            <span class="pm-view-icon"></span>
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

        @if (ShowItemDetailsPanel && SelectedStock is not null)
        {
            <div class="ap-itemdetails-overlay">
                <div class="ap-itemdetails-panel">
                    <div class="ap-itemdetails-header">
                        <h2 class="ap-itemdetails-title">Item Details</h2>
                        <div class="ap-itemdetails-name">@SelectedStock.Name</div>
                    </div>

                    <div class="ap-itemdetails-section">
                        <div class="ap-itemdetails-section-title">Basic Information</div>
                        <div class="ap-itemdetails-row">
                            <span class="ap-itemdetails-label">Item Name:</span>
                            <span class="ap-itemdetails-value">@SelectedStock.Name</span>
                        </div>
                        <div class="ap-itemdetails-row">
                            <span class="ap-itemdetails-label">Category:</span>
                            <span class="ap-itemdetails-value">@SelectedStock.Category</span>
                        </div>
                        <div class="ap-itemdetails-row">
                            <span class="ap-itemdetails-label">Supplier:</span>
                            <span class="ap-itemdetails-value">@SelectedStock.Supplier</span>
                        </div>
                        <div class="ap-itemdetails-row">
                            <span class="ap-itemdetails-label">Reorder Level:</span>
                            <span class="ap-itemdetails-value">@InventoryItems.FirstOrDefault(i => i.InventoryId == SelectedStock.InventoryId)?.ReorderLevel.ToString() ?? "N/A" units</span>
                        </div>
                    </div>

                    <div class="ap-itemdetails-section">
                        <div class="ap-itemdetails-section-title">Recent Activity</div>
                        <div class="ap-itemdetails-list">
                            <div>11/15: OUT -10 (Prescription)</div>
                            <div>11/14: OUT -15 (Prescription)</div>
                            <div>11/13: OUT -12 (Prescription)</div>
                            <div>11/10: IN +100 (Purchase)</div>
                        </div>
                    </div>

                    <div class="ap-itemdetails-section">
                        <div class="ap-itemdetails-section-title">Alerts &amp; Status</div>
                        <div class="ap-itemdetails-row">
                            <span class="ap-itemdetails-label">Stock Status:</span>
                            <span class="ip-status-pill ip-status-@SelectedStock.StatusKey">
                                <span class="ip-status-dot"></span>
                                <span>@SelectedStock.StatusLabel</span>
                            </span>
                        </div>
                        <div class="ap-itemdetails-row">
                            <span class="ap-itemdetails-label">Expiry Alert:</span>
                            <span class="ap-itemdetails-value">@(SelectedStock.ExpiryDate?.ToString("MM/dd/yy") ?? "N/A")</span>
                        </div>
                        <div class="ap-itemdetails-row">
                            <span class="ap-itemdetails-label">Monthly Usage:</span>
                            <span class="ap-itemdetails-value">~1,200 units</span>
                        </div>
                        <div class="ap-itemdetails-row">
                            <span class="ap-itemdetails-label">Unit Price:</span>
                            <span class="ap-itemdetails-value">₱@SelectedStock.UnitPrice.ToString("F2")</span>
                        </div>
                    </div>

                    <div class="ap-itemdetails-footer">
                        <button type="button" class="ap-itemdetails-close" @onclick="CloseItemDetails">Close</button>
                    </div>
                </div>
            </div>
        }

        <div class="pm-pagination">
            <button class="pm-page-btn">Previous</button>
            <button class="pm-page-number active">1</button>
            <button class="pm-page-number">2</button>
            <button class="pm-page-number">3</button>
            <span class="pm-page-dots">...</span>
            <button class="pm-page-number">8</button>
            <button class="pm-page-btn">Next</button>
        </div>
    </section>
</div>

@code {
    private bool ShowItemDetailsPanel { get; set; }
    private StockRow? SelectedStock { get; set; }
    private List<Models.PharmacyInventory> InventoryItems { get; set; } = new();
    private bool IsLoading = true;
    private string ErrorMessage = "";

    public record StockRow(
        int InventoryId,
        string Name,
        string Category,
        int Stock,
        string Value,
        string Trend,
        string StatusKey,
        string StatusLabel,
        string Supplier,
        DateTime? ExpiryDate,
        decimal UnitPrice
    );

    private List<StockRow> Stocks => InventoryItems.Select(item => new StockRow(
        item.InventoryId,
        item.ItemName,
        item.Category ?? "Unknown",
        item.StockQuantity,
        $"₱{(item.StockQuantity * item.UnitPrice):F2}",
        CalculateTrend(item),
        item.StatusKey,
        item.Status,
        item.Supplier ?? "Not specified",
        item.ExpiryDate,
        item.UnitPrice
    )).ToList();

    private string CalculateTrend(Models.PharmacyInventory item)
    {
        // Simple trend calculation based on stock level
        if (item.StockQuantity <= item.ReorderLevel)
            return "▼ -15%";
        if (item.StockQuantity >= item.ReorderLevel * 2)
            return "▲ +5%";
        return "▬ Stable";
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadInventory();
    }

    private async Task LoadInventory()
    {
        try
        {
            IsLoading = true;
            ErrorMessage = "";
            StateHasChanged();

            InventoryItems = await DbContext.PharmacyInventory
                .Where(i => !i.IsArchived)
                .OrderByDescending(i => i.CreatedAt)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading inventory: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private void OpenItemDetails(StockRow row)
    {
        SelectedStock = row;
        ShowItemDetailsPanel = true;
    }

    private void CloseItemDetails()
    {
        ShowItemDetailsPanel = false;
        SelectedStock = null;
    }
}










