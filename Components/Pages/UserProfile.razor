@page "/user-profile"
@page "/{role}user-profile"
@layout Layout.DashboardLayout

@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using IT_13FinalProject.Models
@using IT_13FinalProject.Services
@inject NavigationManager Navigation
@inject IUserAccountService UserAccountService
@inject CurrentUserState CurrentUserState
@inject IJSRuntime JsRuntime

<div class="dashboard-page up-page">
    <header class="dashboard-header">
        <div>
            <h1 class="dashboard-title">User Profile</h1>
            <p class="dashboard-subtitle">Welcome back @(string.IsNullOrEmpty(Role) ? "User" : Role)!</p>
        </div>

        <div class="dashboard-user-info">
            <span class="dashboard-user-email">@(_user?.Email ?? string.Empty)</span>
            <div class="dashboard-user-avatar">@HeaderInitials</div>
            <span class="dashboard-user-name">@(_user?.FullName ?? _user?.Username ?? "User")</span>
        </div>
    </header>

    <section class="up-main">
        <div class="up-topbar">
            <div class="up-userchip">
                <div class="up-userchip-avatar">@HeaderInitials</div>
                <div class="up-userchip-text">
                    <div class="up-userchip-name">@(_user?.FullName ?? _user?.Username ?? "User")</div>
                    <div class="up-userchip-email">@(_user?.Email ?? string.Empty)</div>
                </div>
            </div>
        </div>

        <div class="up-card">
            <div class="up-card-inner">
                <div class="up-left">
                    <div class="up-photo-frame">
                        <div class="up-photo-icon">＋</div>
                    </div>
                    <div class="up-upload-row">
                        <InputFile OnChange="OnProfileImageSelected" />
                    </div>
                </div>

                <div class="up-right">
                    <h2 class="up-name">@(_user?.FullName ?? _user?.Username ?? "User")</h2>
                    <div class="up-field-row"><span class="up-field-label">Email:</span> <a href="mailto:@(_user?.Email ?? string.Empty)" class="up-field-link">@(_user?.Email ?? string.Empty)</a></div>
                    <div class="up-field-row"><span class="up-field-label">Username:</span> <span class="up-field-value">@(_user?.Username ?? string.Empty)</span></div>
                    <div class="up-field-row"><span class="up-field-label">Pass:</span> <span class="up-field-value">•••••</span></div>
                    <div class="up-field-row"><span class="up-field-label">Role:</span> <span class="up-field-value">@(_user?.Role ?? (string.IsNullOrEmpty(Role) ? "User" : Role))</span></div>

                    <div class="up-actions">
                        <button type="button" class="up-action-link" @onclick="() => ShowMoreDetails = true">Add more details</button>
                        <button type="button" class="up-action-link" @onclick="() => ShowEditDetails = true">Edit details</button>
                        <button type="button" class="up-action-link" @onclick="() => ShowResetOptions = true">Reset Credentials</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- More Details Modal -->
    @if (ShowMoreDetails)
    {
        <div class="up-more-overlay">
            <div class="up-more-panel">
                <h2 class="up-more-title">More Details</h2>
                <div class="up-more-fields">
                    <input class="up-more-input" placeholder="Address" />
                    <input class="up-more-input" placeholder="Contact" />
                    <input class="up-more-input" placeholder="Nationality" />
                    <input class="up-more-input" placeholder="Profession" />
                    <input class="up-more-input" placeholder="Socialization" />
                    <input class="up-more-input" placeholder="License No." />
                    <input class="up-more-input" placeholder="Date of Birth" />
                    <select class="up-more-input">
                        <option value="" disabled selected>Gender</option>
                        <option>Male</option>
                        <option>Female</option>
                        <option>Other</option>
                    </select>
                </div>
                <div class="up-more-actions">
                    <button type="button" class="up-more-btn up-more-cancel" @onclick="() => ShowMoreDetails = false">Cancel</button>
                    <button type="button" class="up-more-btn up-more-save" @onclick="SaveMoreDetails">Save</button>
                </div>
            </div>
        </div>
    }

    <!-- Edit Details Modal -->
    @if (ShowEditDetails)
    {
        <div class="up-more-overlay">
            <div class="up-more-panel">
                <h2 class="up-more-title">Edit Details</h2>
                <div class="up-more-fields">
                    <input class="up-more-input" placeholder="Name" @bind="EditFullName" />
                    <input class="up-more-input" placeholder="Email" @bind="EditEmail" />
                </div>
                <div class="up-more-actions">
                    <button type="button" class="up-more-btn up-more-cancel" @onclick="() => ShowEditDetails = false">Cancel</button>
                    <button type="button" class="up-more-btn up-more-save" @onclick="SaveEditDetails" disabled="@IsSaving">Save</button>
                </div>
            </div>
        </div>
    }

    <!-- Reset Options Modal -->
    @if (ShowResetOptions)
    {
        <div class="up-more-overlay">
            <div class="up-more-panel">
                <h2 class="up-more-title">Reset Credentials</h2>
                <div class="up-reset-options">
                    <button type="button" class="up-reset-option-btn" @onclick="() => { ShowResetOptions = false; ShowChangeUsername = true; }">Change Username</button>
                    <button type="button" class="up-reset-option-btn" @onclick="() => { ShowResetOptions = false; ShowChangePassword = true; }">Change Password</button>
                </div>
                <div class="up-more-actions">
                    <button type="button" class="up-more-btn up-more-cancel" @onclick="() => ShowResetOptions = false">Cancel</button>
                </div>
            </div>
        </div>
    }

    <!-- Change Username Modal -->
    @if (ShowChangeUsername)
    {
        <div class="up-more-overlay">
            <div class="up-more-panel">
                <h2 class="up-more-title">Change Username</h2>
                <div class="up-more-fields">
                    <input class="up-more-input" placeholder="Current username" value="@(_user?.Username ?? string.Empty)" disabled />
                    <input class="up-more-input" placeholder="New username" @bind="NewUsername" />
                    <input class="up-more-input" placeholder="Confirm new username" @bind="ConfirmNewUsername" />
                </div>
                <div class="up-more-actions">
                    <button type="button" class="up-more-btn up-more-cancel" @onclick="() => ShowChangeUsername = false">Cancel</button>
                    <button type="button" class="up-more-btn up-more-save" @onclick="SaveChangeUsername" disabled="@IsSaving">Save</button>
                </div>
            </div>
        </div>
    }

    <!-- Change Password Modal -->
    @if (ShowChangePassword)
    {
        <div class="up-more-overlay">
            <div class="up-more-panel">
                <h2 class="up-more-title">Change Password</h2>
                <div class="up-more-fields">
                    <input type="password" class="up-more-input" placeholder="Current password" />
                    <input type="password" class="up-more-input" placeholder="New password" @bind="NewPassword" />
                    <input type="password" class="up-more-input" placeholder="Confirm new password" @bind="ConfirmNewPassword" />
                </div>
                <div class="up-more-actions">
                    <button type="button" class="up-more-btn up-more-cancel" @onclick="() => ShowChangePassword = false">Cancel</button>
                    <button type="button" class="up-more-btn up-more-save" @onclick="SaveChangePassword" disabled="@IsSaving">Save</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public string? Role { get; set; }

    [Parameter]
    public EventCallback<string> RoleChanged { get; set; }

    // State variables
    private bool ShowMoreDetails { get; set; }
    private bool ShowEditDetails { get; set; }
    private bool ShowResetOptions { get; set; }
    private bool ShowChangePassword { get; set; }
    private bool ShowChangeUsername { get; set; }
    private string? _selectedFileName;

    private User? _user;
    private string EditFullName { get; set; } = string.Empty;
    private string EditEmail { get; set; } = string.Empty;
    private string NewUsername { get; set; } = string.Empty;
    private string ConfirmNewUsername { get; set; } = string.Empty;
    private string NewPassword { get; set; } = string.Empty;
    private string ConfirmNewPassword { get; set; } = string.Empty;
    private bool IsSaving { get; set; }

    private string HeaderInitials
    {
        get
        {
            var name = _user?.FullName;
            if (string.IsNullOrWhiteSpace(name))
                name = _user?.Username;

            if (string.IsNullOrWhiteSpace(name))
                return "U";

            var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            if (parts.Length == 1)
                return parts[0].Substring(0, 1).ToUpperInvariant();

            var first = parts[0].Substring(0, 1).ToUpperInvariant();
            var last = parts[^1].Substring(0, 1).ToUpperInvariant();
            return first + last;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadUser();
    }

    private async Task LoadUser()
    {
        try
        {
            if (!CurrentUserState.IsAuthenticated || string.IsNullOrWhiteSpace(CurrentUserState.Username))
            {
                var restoredUsername = await JsRuntime.InvokeAsync<string>("localStorage.getItem", "medflow.username");
                if (!string.IsNullOrWhiteSpace(restoredUsername))
                {
                    var restored = await UserAccountService.GetUserByUsernameAsync(restoredUsername);
                    if (restored != null)
                    {
                        CurrentUserState.Set(restored);
                    }
                }
            }

            if (!CurrentUserState.IsAuthenticated || string.IsNullOrWhiteSpace(CurrentUserState.Username))
            {
                _user = null;
                return;
            }

            if (CurrentUserState.UserId == 0)
            {
                _user = new User
                {
                    Id = 0,
                    Username = CurrentUserState.Username ?? string.Empty,
                    Role = CurrentUserState.Role ?? string.Empty,
                    Email = CurrentUserState.Email,
                    FullName = CurrentUserState.FullName,
                    IsActive = true
                };
            }
            else
            {
                _user = await UserAccountService.GetUserByUsernameAsync(CurrentUserState.Username);
            }

            if (_user != null)
            {
                EditFullName = _user.FullName ?? string.Empty;
                EditEmail = _user.Email ?? string.Empty;
            }
        }
        catch (Exception ex)
        {
            await JsRuntime.InvokeVoidAsync("alert", $"Failed to load user profile: {ex.Message}");
        }
    }

    // Methods
    private void OnProfileImageSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        _selectedFileName = file?.Name;
        // Handle file upload here
    }

    private void SaveMoreDetails()
    {
        // Save more details logic
        ShowMoreDetails = false;
        // Show success message
    }

    private async Task SaveEditDetails()
    {
        if (IsSaving)
            return;

        if (_user == null)
        {
            await JsRuntime.InvokeVoidAsync("alert", "No user loaded.");
            return;
        }

        try
        {
            IsSaving = true;
            var updated = new User
            {
                Id = _user.Id,
                Username = _user.Username,
                Role = _user.Role,
                Email = EditEmail,
                FullName = EditFullName,
                IsActive = _user.IsActive
            };

            var saved = await UserAccountService.UpdateUserAsync(updated);
            if (saved != null)
            {
                _user = saved;
                CurrentUserState.Set(saved);
                ShowEditDetails = false;
            }
        }
        catch (Exception ex)
        {
            await JsRuntime.InvokeVoidAsync("alert", ex.Message);
        }
        finally
        {
            IsSaving = false;
        }
    }

    private async Task SaveChangeUsername()
    {
        if (IsSaving)
            return;

        if (_user == null)
        {
            await JsRuntime.InvokeVoidAsync("alert", "No user loaded.");
            return;
        }

        if (string.IsNullOrWhiteSpace(NewUsername) || !string.Equals(NewUsername, ConfirmNewUsername, StringComparison.Ordinal))
        {
            await JsRuntime.InvokeVoidAsync("alert", "Username confirmation does not match.");
            return;
        }

        try
        {
            IsSaving = true;
            var saved = await UserAccountService.ChangeUsernameAsync(_user.Id, NewUsername);
            if (saved != null)
            {
                _user = saved;
                CurrentUserState.Set(saved);
                NewUsername = string.Empty;
                ConfirmNewUsername = string.Empty;
                ShowChangeUsername = false;
            }
        }
        catch (Exception ex)
        {
            await JsRuntime.InvokeVoidAsync("alert", ex.Message);
        }
        finally
        {
            IsSaving = false;
        }
    }

    private async Task SaveChangePassword()
    {
        if (IsSaving)
            return;

        if (_user == null)
        {
            await JsRuntime.InvokeVoidAsync("alert", "No user loaded.");
            return;
        }

        if (string.IsNullOrWhiteSpace(NewPassword) || !string.Equals(NewPassword, ConfirmNewPassword, StringComparison.Ordinal))
        {
            await JsRuntime.InvokeVoidAsync("alert", "Password confirmation does not match.");
            return;
        }

        try
        {
            IsSaving = true;
            var saved = await UserAccountService.ChangePasswordAsync(_user.Id, NewPassword);
            if (saved != null)
            {
                _user = saved;
                CurrentUserState.Set(saved);
                NewPassword = string.Empty;
                ConfirmNewPassword = string.Empty;
                ShowChangePassword = false;
            }
        }
        catch (Exception ex)
        {
            await JsRuntime.InvokeVoidAsync("alert", ex.Message);
        }
        finally
        {
            IsSaving = false;
        }
    }
}
