@page "/doctor-health-records"
@layout Layout.DashboardLayout
@using IT_13FinalProject.Models
@using IT_13FinalProject.Data
@using Microsoft.EntityFrameworkCore
@using System.Linq

@inject ApplicationDbContext DbContext
@inject LocalDbContext LocalDbContext
@inject NavigationManager Navigation
@inject IJSRuntime JsRuntime

<div class="pm-page">
    <header class="dashboard-header">
        <div>
            <h1 class="dashboard-title">Health Record List</h1>
            <p class="dashboard-subtitle">Welcome back Clinical Staff!</p>
        </div>

        <div class="dashboard-user-info">
            <span class="dashboard-user-email">doctor@gmail.com</span>
            <div class="dashboard-user-avatar">DR</div>
            <span class="dashboard-user-name">Clinical</span>
        </div>
    </header>

    <section class="pm-overview">
        <div class="pm-overview-header">
            <h2 class="pm-section-title">Health Record List</h2>
            <div class="pm-show-entries">
                <span>Show</span>
                <select @bind="PageSize">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="25">25</option>
                </select>
                <span>entries</span>
            </div>
        </div>

        <div class="pm-filters-row">
            <div class="pm-tab-container">
                <button class="pm-tab-btn @(ShowArchived ? "" : "active")" @onclick="() => SetArchiveView(false)">
                    Active Records
                </button>
                <button class="pm-tab-btn @(ShowArchived ? "active" : "")" @onclick="() => SetArchiveView(true)">
                    Archived Records
                </button>
            </div>
            <div class="pm-search-row">
                <div class="pm-search-box">
                    <span class="pm-search-icon"></span>
                    <input class="pm-search-input" placeholder="Search Patient" />
                </div>

                <div class="pm-actions">
                    <button class="activity-action-btn">Sort</button>
                    <button class="activity-action-btn">Filters</button>
                </div>
            </div>
        </div>

        <div class="pm-table-outer">
            <div class="pm-table-wrapper">
                <table class="pm-table">
                    <thead>
                        <tr>
                            <th class="pm-col-id">ID</th>
                            <th>Patient Name</th>
                            <th>Email</th>
                            <th>Assessment Status</th>
                            <th class="pm-col-date">Date of Visit</th>
                            <th class="pm-col-status">Diagnosis</th>
                            <th class="pm-col-action">Visit Details</th>
                            <th class="pm-col-actions">Manage</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (IsLoading)
                        {
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 2rem;">
                                    <div>Loading health records...</div>
                                </td>
                            </tr>
                        }
                        else if (!string.IsNullOrEmpty(ErrorMessage))
                        {
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 2rem;">
                                    <div style="color: red;">Error: @ErrorMessage</div>
                                    <button class="pm-back-btn" @onclick="LoadHealthRecords" style="margin-top: 1rem;">Retry</button>
                                </td>
                            </tr>
                        }
                        else if (HealthRecords.Count == 0)
                        {
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 2rem;">
                                    <div>No health records found.</div>
                                    <div style="margin-top: 1rem;">
                                        <button class="pm-add-vitals-btn" @onclick="GoToConsultationForm">
                                            <span>+ Add Consultation</span>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var healthRecord in PagedHealthRecords)
                            {
                                try
                                {
                                    <tr>
                                        <td class="pm-col-id">@healthRecord?.RecordId</td>
                                        <td>
                                            <div class="pm-patient-name">@(healthRecord?.Patient?.FirstName + " " + healthRecord?.Patient?.LastName ?? "Unknown")</div>
                                        </td>
                                        <td>
                                            <div class="pm-patient-email">@(healthRecord?.Patient?.Email ?? "No email")</div>
                                        </td>
                                        <td>@(healthRecord?.VisitStatus ?? "New")</td>
                                        <td class="pm-col-date">@(healthRecord?.RecordDate?.ToString("MM/dd/yyyy") ?? "N/A")</td>
                                        <td class="pm-col-status">@(!string.IsNullOrEmpty(healthRecord?.AssessmentDiagnosis) && healthRecord.AssessmentDiagnosis.Length > 50 ? healthRecord.AssessmentDiagnosis.Substring(0, 50) + "..." : healthRecord?.AssessmentDiagnosis ?? "No diagnosis")</td>
                                        <td class="pm-col-action">
                                            <button class="pm-view-btn" @onclick="() => ViewHealthRecord(healthRecord?.RecordId ?? 0)" aria-label="View health record details">
                                                <span class="pm-view-icon"></span>
                                            </button>
                                        </td>
                                        <td class="pm-col-actions">
                                            <div class="pm-action-buttons">
                                                @if (ShowArchived)
                                                {
                                                    <button class="pm-restore-btn" @onclick="() => RestoreHealthRecord(healthRecord?.RecordId ?? 0)" title="Restore Health Record">
                                                        <span class="pm-restore-icon"></span>
                                                    </button>
                                                    <button class="pm-delete-btn" @onclick="() => DeleteHealthRecord(healthRecord?.RecordId ?? 0)" title="Delete Permanently">
                                                        <span class="pm-delete-icon"></span>
                                                    </button>
                                                }
                                                else
                                                {
                                                    <button class="pm-edit-btn" @onclick="() => ShowEditHealthRecordModal(healthRecord)" title="Edit Health Record">
                                                        <span class="pm-edit-icon"></span>
                                                    </button>
                                                    <button class="pm-archive-btn" @onclick="() => ArchiveHealthRecord(healthRecord?.RecordId ?? 0)" title="Archive Health Record">
                                                        <span class="pm-archive-icon"></span>
                                                    </button>
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                }
                                catch (Exception ex)
                                {
                                    <tr>
                                        <td colspan="8" style="text-align: center; padding: 1rem;">
                                            <div style="color: orange;">Error displaying consultation: @ex.Message</div>
                                        </td>
                                    </tr>
                                }
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

        @if (ShowPagination)
        {
            <div class="pm-pagination pm-pagination-health-records">
                <button class="pm-page-btn">Previous</button>
                <button class="pm-page-number active">1</button>
                <button class="pm-page-number">2</button>
                <button class="pm-page-number">3</button>
                <span class="pm-page-dots">...</span>
                <button class="pm-page-number">8</button>
                <button class="pm-page-btn">Next</button>
            </div>
        }
    </section>
</div>

<!-- Edit Health Record Modal -->
@if (ShowEditModal)
{
    <div class="pm-modal-overlay" @onclick="HideEditHealthRecordModal">
        <div class="pm-modal" @onclick:stopPropagation>
            <div class="pm-modal-header">
                <h3>Edit Health Record</h3>
                <button class="pm-modal-close" @onclick="HideEditHealthRecordModal">×</button>
            </div>
            <div class="pm-modal-body">
                <div class="pm-form-grid">
                    <div class="pm-form-group">
                        <label>Patient</label>
                        <input class="pm-form-input" value="@(EditingHealthRecord?.Patient?.FirstName + " " + EditingHealthRecord?.Patient?.LastName ?? "Unknown")" readonly />
                    </div>
                    <div class="pm-form-group">
                        <label>Visit Status</label>
                        <select class="pm-form-input" @bind="EditingHealthRecord.VisitStatus">
                            <option value="New">New</option>
                            <option value="Follow-up">Follow-up</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                    <div class="pm-form-group pm-form-full">
                        <label>Chief Complaint</label>
                        <textarea class="pm-form-input" @bind="EditingHealthRecord.ChiefComplaint"></textarea>
                    </div>
                    <div class="pm-form-group pm-form-full">
                        <label>Subjective Findings</label>
                        <textarea class="pm-form-input" @bind="EditingHealthRecord.SubjectiveFindings"></textarea>
                    </div>
                    <div class="pm-form-group pm-form-full">
                        <label>Objective Findings</label>
                        <textarea class="pm-form-input" @bind="EditingHealthRecord.ObjectiveFindings"></textarea>
                    </div>
                    <div class="pm-form-group pm-form-full">
                        <label>Assessment / Diagnosis</label>
                        <textarea class="pm-form-input" @bind="EditingHealthRecord.AssessmentDiagnosis"></textarea>
                    </div>
                    <div class="pm-form-group pm-form-full">
                        <label>Recommendations</label>
                        <textarea class="pm-form-input" @bind="EditingHealthRecord.Recommendations"></textarea>
                    </div>
                    <div class="pm-form-group pm-form-full">
                        <label>Doctor's Initial Remarks</label>
                        <textarea class="pm-form-input" @bind="EditingHealthRecord.DoctorInitialRemarks"></textarea>
                    </div>
                    <div class="pm-form-group pm-form-full">
                        <label>Special Instructions</label>
                        <textarea class="pm-form-input" @bind="EditingHealthRecord.SpecialInstructions"></textarea>
                    </div>
                </div>
            </div>
            <div class="pm-modal-footer">
                <button class="pm-btn pm-btn-secondary" @onclick="HideEditHealthRecordModal">Cancel</button>
                <button class="pm-btn pm-btn-primary" @onclick="UpdateHealthRecord">Update Health Record</button>
            </div>
        </div>
    </div>
}

<!-- View Health Record Modal -->
@if (ShowViewModal && ViewingHealthRecord != null)
{
    <div class="pm-modal-overlay" @onclick="HideViewHealthRecordModal">
        <div class="pm-modal pm-modal-large" @onclick:stopPropagation>
            <div class="pm-modal-header">
                <h3>Health Record Details</h3>
                <button class="pm-modal-close" @onclick="HideViewHealthRecordModal">×</button>
            </div>
            <div class="pm-modal-body">
                <div class="pm-view-grid">
                    <div class="pm-view-column">
                        <h4>Patient Information</h4>
                        <div class="pm-view-field">
                            <label>Patient Name</label>
                            <div class="pm-view-value">@(ViewingHealthRecord.Patient?.FirstName + " " + ViewingHealthRecord.Patient?.LastName ?? "Unknown")</div>
                        </div>
                        <div class="pm-view-field">
                            <label>Email</label>
                            <div class="pm-view-value">@(ViewingHealthRecord.Patient?.Email ?? "No email")</div>
                        </div>
                        <div class="pm-view-field">
                            <label>Date of Visit</label>
                            <div class="pm-view-value">@(ViewingHealthRecord.RecordDate?.ToString("MM/dd/yyyy") ?? "N/A")</div>
                        </div>
                        <div class="pm-view-field">
                            <label>Visit Status</label>
                            <div class="pm-view-value">@(ViewingHealthRecord.VisitStatus ?? "New")</div>
                        </div>

                        <h4>Clinical Findings</h4>
                        <div class="pm-view-field">
                            <label>Subjective Findings</label>
                            <div class="pm-view-value">@(ViewingHealthRecord.SubjectiveFindings ?? "Not specified")</div>
                        </div>
                        <div class="pm-view-field">
                            <label>Objective Findings</label>
                            <div class="pm-view-value">@(ViewingHealthRecord.ObjectiveFindings ?? "Not specified")</div>
                        </div>
                        <div class="pm-view-field">
                            <label>Assessment / Diagnosis</label>
                            <div class="pm-view-value">@(ViewingHealthRecord.AssessmentDiagnosis ?? "Not specified")</div>
                        </div>
                    </div>

                    <div class="pm-view-column">
                        <h4>Treatment / Prescription</h4>
                        <div class="pm-view-field">
                            <label>Medicine Name</label>
                            <div class="pm-view-value">@(ViewingHealthRecord.MedicineName ?? "Not specified")</div>
                        </div>
                        <div class="pm-view-field">
                            <label>Dosage</label>
                            <div class="pm-view-value">@(ViewingHealthRecord.Dosage ?? "Not specified")</div>
                        </div>
                        <div class="pm-view-field">
                            <label>Frequency</label>
                            <div class="pm-view-value">@(ViewingHealthRecord.Frequency ?? "Not specified")</div>
                        </div>
                        <div class="pm-view-field">
                            <label>Duration</label>
                            <div class="pm-view-value">@(ViewingHealthRecord.Duration ?? "Not specified")</div>
                        </div>
                        <div class="pm-view-field">
                            <label>Notes / Special Instructions</label>
                            <div class="pm-view-value">@(ViewingHealthRecord.SpecialInstructions ?? "Not specified")</div>
                        </div>

                        <h4>Follow-up &amp; Outcome</h4>
                        <div class="pm-view-field">
                            <label>Follow-up Date</label>
                            <div class="pm-view-value">@(ViewingHealthRecord.FollowUpDate?.ToString("MM/dd/yyyy") ?? "Not specified")</div>
                        </div>
                        <div class="pm-view-field">
                            <label>Visit Status</label>
                            <div class="pm-view-value">@(ViewingHealthRecord.VisitStatus ?? "Not specified")</div>
                        </div>

                        <h4>Doctor Approval</h4>
                        <div class="pm-view-field">
                            <label>Doctor Signature / Name</label>
                            <div class="pm-view-value">@(ViewingHealthRecord.DoctorSignature ?? "Not specified")</div>
                        </div>
                        <div class="pm-view-field">
                            <label>Date Approved</label>
                            <div class="pm-view-value">@(ViewingHealthRecord.ApprovalDate?.ToString("MM/dd/yyyy") ?? "Not specified")</div>
                        </div>
                        <div class="pm-view-field">
                            <label>Doctors Initial Remarks</label>
                            <div class="pm-view-value">@(ViewingHealthRecord.DoctorInitialRemarks ?? "Not specified")</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="pm-modal-footer">
                <button class="pm-btn pm-btn-secondary" @onclick="HideViewHealthRecordModal">Close</button>
            </div>
        </div>
    </div>
}

@code {
    private List<Models.HealthRecord> HealthRecords { get; set; } = new();
    private bool IsLoading = true;
    private string ErrorMessage = "";
    private bool ShowPagination = true;
        
    // Pagination
    private int CurrentPage { get; set; } = 1;
    private int _pageSize = 5;
    private int PageSize
    {
        get => _pageSize;
        set
        {
            _pageSize = value;
            CurrentPage = 1;
        }
    }

    private int TotalPages => PageSize <= 0 || HealthRecords.Count == 0
        ? 0
        : (int)Math.Ceiling(HealthRecords.Count / (double)PageSize);

    private IEnumerable<Models.HealthRecord> PagedHealthRecords =>
        TotalPages == 0
            ? Enumerable.Empty<Models.HealthRecord>()
            : HealthRecords
                .Skip((CurrentPage - 1) * PageSize)
                .Take(PageSize);

    // Modal properties
    private bool ShowEditModal = false;
    private Models.HealthRecord EditingHealthRecord = new Models.HealthRecord();
    private bool ShowViewModal = false;
    private Models.HealthRecord? ViewingHealthRecord;
    private bool ShowArchived = false;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadHealthRecords();
    }
    
    private async Task LoadHealthRecords()
    {
        try
        {
            IsLoading = true;
            ErrorMessage = "";
            StateHasChanged();
            
            HealthRecords = await DbContext.HealthRecords
                .Include(hr => hr.Patient)
                .Where(hr => hr.IsArchived == ShowArchived)
                .OrderByDescending(hr => hr.RecordDate)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading health records: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            ErrorMessage = $"Error loading health records: {ex.Message}";
            
            // Try to load health records without ordering to isolate the issue
            try
            {
                HealthRecords = await DbContext.HealthRecords
                    .Include(c => c.Patient)
                    .ToListAsync();
                Console.WriteLine($"Loaded {HealthRecords.Count} health records without ordering");
            }
            catch (Exception innerEx)
            {
                Console.WriteLine($"Error loading without ordering: {innerEx.Message}");
            }
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task ViewHealthRecord(int recordId)
    {
        try
        {
            ViewingHealthRecord = await DbContext.HealthRecords
                .Include(hr => hr.Patient)
                .FirstOrDefaultAsync(hr => hr.RecordId == recordId);

            if (ViewingHealthRecord != null)
            {
                ShowViewModal = true;
            }
        }
        catch (Exception ex)
        {
            await JsRuntime.InvokeVoidAsync("alert", $"Error loading health record: {ex.Message}");
        }
    }
    
    private void GoToConsultationForm()
    {
        Navigation.NavigateTo("/doctor-consultation");
    }

    private void TogglePagination()
    {
        ShowPagination = !ShowPagination;
    }
    
    private void GoToPage(int page)
    {
        if (TotalPages == 0)
        {
            return;
        }

        if (page < 1)
        {
            page = 1;
        }
        else if (page > TotalPages)
        {
            page = TotalPages;
        }

        CurrentPage = page;
    }

    private void PreviousPage() => GoToPage(CurrentPage - 1);

    private void NextPage() => GoToPage(CurrentPage + 1);
    
    // Modal methods
    private void ShowEditHealthRecordModal(Models.HealthRecord healthRecord)
    {
        // Load the health record with patient data
        var recordWithPatient = DbContext.HealthRecords
            .Include(hr => hr.Patient)
            .FirstOrDefault(hr => hr.RecordId == healthRecord.RecordId);
            
        if (recordWithPatient != null)
        {
            EditingHealthRecord = recordWithPatient;
            ShowEditModal = true;
        }
    }
    
    private void HideEditHealthRecordModal()
    {
        ShowEditModal = false;
        EditingHealthRecord = new Models.HealthRecord();
    }

    private void HideViewHealthRecordModal()
    {
        ShowViewModal = false;
        ViewingHealthRecord = null;
    }
    
    // CRUD operations
    private async Task UpdateHealthRecord()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(EditingHealthRecord.AssessmentDiagnosis))
            {
                ErrorMessage = "Assessment/Diagnosis is required.";
                await JsRuntime.InvokeVoidAsync("alert", ErrorMessage);
                return;
            }
            
            DbContext.HealthRecords.Update(EditingHealthRecord);
            await DbContext.SaveChangesAsync();
            
            await LoadHealthRecords();
            HideEditHealthRecordModal();
            await JsRuntime.InvokeVoidAsync("alert", "Health record updated successfully!");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error updating health record: {ex.Message}";
            await JsRuntime.InvokeVoidAsync("alert", ErrorMessage);
        }
    }
    
    private async Task ArchiveHealthRecord(int recordId)
    {
        bool confirmed = await JsRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to archive this health record?");
        
        if (!confirmed)
        {
            return;
        }
        
        try
        {
            var healthRecord = await DbContext.HealthRecords.FindAsync(recordId);
            if (healthRecord != null)
            {
                healthRecord.IsArchived = true;
                healthRecord.ArchivedAt = DateTime.Now;
                await DbContext.SaveChangesAsync();
                
                // Also archive in local database
                try
                {
                    var localHealthRecord = await LocalDbContext.HealthRecords.FindAsync(recordId);
                    if (localHealthRecord != null)
                    {
                        localHealthRecord.IsArchived = true;
                        localHealthRecord.ArchivedAt = DateTime.Now;
                        await LocalDbContext.SaveChangesAsync();
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Failed to archive health record in local: {ex.Message}");
                }

                // Simple audit trail
                Console.WriteLine($"[AUDIT] Health record {recordId} archived at {DateTime.UtcNow:O}.");
                
                await LoadHealthRecords();
                await JsRuntime.InvokeVoidAsync("alert", "Health record archived successfully!");
            }
        }
        catch (Exception ex)
        {
            await JsRuntime.InvokeVoidAsync("alert", $"Error archiving health record: {ex.Message}");
        }
    }
    
    private async Task SetArchiveView(bool showArchived)
    {
        ShowArchived = showArchived;
        await LoadHealthRecords();
    }
    
    private async Task RestoreHealthRecord(int recordId)
    {
        bool confirmed = await JsRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to restore this health record?");
        
        if (!confirmed)
        {
            return;
        }
        
        try
        {
            var healthRecord = await DbContext.HealthRecords.FindAsync(recordId);
            if (healthRecord != null)
            {
                healthRecord.IsArchived = false;
                healthRecord.ArchivedAt = null;
                await DbContext.SaveChangesAsync();
                
                // Also restore in local database
                try
                {
                    var localHealthRecord = await LocalDbContext.HealthRecords.FindAsync(recordId);
                    if (localHealthRecord != null)
                    {
                        localHealthRecord.IsArchived = false;
                        localHealthRecord.ArchivedAt = null;
                        await LocalDbContext.SaveChangesAsync();
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Failed to restore health record in local: {ex.Message}");
                }

                // Simple audit trail
                Console.WriteLine($"[AUDIT] Health record {recordId} restored at {DateTime.UtcNow:O}.");
                
                await LoadHealthRecords();
                await JsRuntime.InvokeVoidAsync("alert", "Health record restored successfully!");
            }
        }
        catch (Exception ex)
        {
            await JsRuntime.InvokeVoidAsync("alert", $"Error restoring health record: {ex.Message}");
        }
    }
    
    private async Task DeleteHealthRecord(int recordId)
    {
        bool confirmed = await JsRuntime.InvokeAsync<bool>("confirm", "This will permanently delete the health record. Continue?");

        if (!confirmed)
        {
            return;
        }

        try
        {
            var healthRecord = await DbContext.HealthRecords.FindAsync(recordId);
            if (healthRecord != null)
            {
                // Enforce ERP rule: only archived records can be permanently deleted
                if (!healthRecord.IsArchived)
                {
                    await JsRuntime.InvokeVoidAsync("alert", "Only archived records can be permanently deleted.");
                    return;
                }

                DbContext.HealthRecords.Remove(healthRecord);
                await DbContext.SaveChangesAsync();

                // Also delete from local database if present
                try
                {
                    var localHealthRecord = await LocalDbContext.HealthRecords.FindAsync(recordId);
                    if (localHealthRecord != null)
                    {
                        LocalDbContext.HealthRecords.Remove(localHealthRecord);
                        await LocalDbContext.SaveChangesAsync();
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Failed to delete health record in local: {ex.Message}");
                }

                // Simple audit trail
                Console.WriteLine($"[AUDIT] Health record {recordId} permanently deleted at {DateTime.UtcNow:O}.");

                await LoadHealthRecords();
                await JsRuntime.InvokeVoidAsync("alert", "Health record deleted permanently!");
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error deleting health record: {ex.Message}";
            await JsRuntime.InvokeVoidAsync("alert", ErrorMessage);
        }
    }
}









