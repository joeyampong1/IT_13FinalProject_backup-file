@page "/doctor-consultation-edit/{consultationId:int}"
@layout Layout.DashboardLayout
@using IT_13FinalProject.Models
@using IT_13FinalProject.Data
@using Microsoft.EntityFrameworkCore

@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject IJSRuntime JsRuntime

<div class="dc-page">
    <header class="dashboard-header">
        <div>
            <h1 class="dashboard-title">Doctors HealthRecord Form</h1>
            <p class="dashboard-subtitle">Clinical Findings, Treatment, and Approval</p>
        </div>

        <div class="dashboard-user-info">
            <span class="dashboard-user-email">doctor@gmail.com</span>
            <div class="dashboard-user-avatar">U</div>
            <span class="dashboard-user-name">Clinical</span>
        </div>
    </header>

    <section class="dc-card">
        <div class="dc-header-row">
            <div class="dc-actions">
                <button class="dc-back-btn" @onclick="GoBack">Back</button>
                <button class="dc-save-btn" @onclick="UpdateHealthRecord" disabled="@IsSaving">@(IsSaving ? "Saving..." : "Update")</button>
            </div>
            <h2 class="dc-title">Doctors HealthRecord Form</h2>
        </div>

        <div class="dc-grid">
            <!-- Clinical Findings -->
            <div class="dc-column">
                <h3 class="dc-section-title">Clinical Findings</h3>

                <label class="dc-field">
                    <span class="dc-label">Subjective Findings</span>
                    <textarea class="dc-input dc-input-multi" @bind="HealthRecord.SubjectiveFindings" oninput="this.style.height='auto';this.style.height=this.scrollHeight + 'px'"></textarea>
                </label>

                <label class="dc-field">
                    <span class="dc-label">Objective Findings</span>
                    <textarea class="dc-input dc-input-multi" @bind="HealthRecord.ObjectiveFindings" oninput="this.style.height='auto';this.style.height=this.scrollHeight + 'px'"></textarea>
                </label>

                <label class="dc-field">
                    <span class="dc-label">Assessment / Diagnosis</span>
                    <textarea class="dc-input dc-input-multi" @bind="HealthRecord.AssessmentDiagnosis" oninput="this.style.height='auto';this.style.height=this.scrollHeight + 'px'"></textarea>
                </label>

                <label class="dc-field">
                    <span class="dc-label">ICD-10 Code</span>
                    <input class="dc-input" @bind="HealthRecord.Icd10Code" />
                </label>

                <label class="dc-field">
                    <span class="dc-label">Additional Tests Order</span>
                    <input class="dc-input" @bind="HealthRecord.AdditionalTestsOrder" />
                </label>

                <label class="dc-field">
                    <span class="dc-label">Doctor's Remarks (Notes)</span>
                    <textarea class="dc-input dc-input-multi" @bind="HealthRecord.DoctorRemarks" oninput="this.style.height='auto';this.style.height=this.scrollHeight + 'px'"></textarea>
                </label>

                <label class="dc-field">
                    <span class="dc-label">Nurse Remarks (Notes)</span>
                    <textarea class="dc-input dc-input-multi" @bind="HealthRecord.NurseRemarks" oninput="this.style.height='auto';this.style.height=this.scrollHeight + 'px'"></textarea>
                </label>

                <label class="dc-field">
                    <span class="dc-label">Recommendation (Notes)</span>
                    <textarea class="dc-input dc-input-multi" @bind="HealthRecord.Recommendations" oninput="this.style.height='auto';this.style.height=this.scrollHeight + 'px'"></textarea>
                </label>
            </div>

            <!-- Treatment / Prescription -->
            <div class="dc-column">
                <h3 class="dc-section-title">Treatment / Prescription</h3>

                <label class="dc-field">
                    <span class="dc-label">Medicine Name</span>
                    <input class="dc-input" @bind="HealthRecord.MedicineName" />
                </label>

                <label class="dc-field">
                    <span class="dc-label">Dosage</span>
                    <input class="dc-input" @bind="HealthRecord.Dosage" />
                </label>

                <label class="dc-field">
                    <span class="dc-label">Frequency</span>
                    <input class="dc-input" @bind="HealthRecord.Frequency" />
                </label>

                <label class="dc-field">
                    <span class="dc-label">Duration</span>
                    <input class="dc-input" @bind="HealthRecord.Duration" />
                </label>

                <label class="dc-field">
                    <span class="dc-label">Notes / Special Instructions</span>
                    <textarea class="dc-input dc-input-multi" @bind="HealthRecord.TreatmentNotes" oninput="this.style.height='auto';this.style.height=this.scrollHeight + 'px'"></textarea>
                </label>

                <h3 class="dc-section-title dc-section-title-spaced">Follow-up &amp; Outcome</h3>

                <label class="dc-field dc-field-inline-icon">
                    <span class="dc-label">Follow-up Date</span>
                    <div class="dc-input-with-icon">
                        <input class="dc-input" type="date" @bind="HealthRecord.FollowUpDate" />
                        <span class="dc-input-icon">ðŸ“…</span>
                    </div>
                </label>

                <label class="dc-field">
                    <span class="dc-label">Visit Status</span>
                    <select class="dc-input" @bind="HealthRecord.VisitStatus">
                        <option value="">Select status</option>
                        <option value="New">New</option>
                        <option value="Follow-up">Follow-up</option>
                        <option value="Completed">Completed</option>
                    </select>
                </label>

                <h3 class="dc-section-title dc-section-title-spaced">Doctor Approval</h3>

                <label class="dc-field">
                    <span class="dc-label">Electronic Signature / Name</span>
                    <select class="dc-input" @bind="HealthRecord.DoctorSignature">
                        <option value="">Select doctor</option>
                        <option value="Doctor 1">Doctor 1</option>
                        <option value="Doctor 2">Doctor 2</option>
                    </select>
                </label>

                <label class="dc-field dc-field-inline-icon">
                    <span class="dc-label">Date Approved</span>
                    <div class="dc-input-with-icon">
                        <input class="dc-input" type="date" @bind="HealthRecord.ApprovalDate" />
                        <span class="dc-input-icon">ðŸ“…</span>
                    </div>
                </label>
            </div>
        </div>

        <div class="dc-notes-section">
            <label class="dc-field">
                <span class="dc-label">Doctors Initial Remarks</span>
                <textarea class="dc-input dc-input-multi" @bind="HealthRecord.DoctorInitialRemarks" oninput="this.style.height='auto';this.style.height=this.scrollHeight + 'px'"></textarea>
            </label>
        </div>

        <div class="dc-actions dc-actions--edit">
            <button class="dc-btn dc-btn-delete">Cancel</button>
            <button class="dc-btn dc-btn-update">Update</button>
        </div>
    </section>
</div>

@code {
    [Parameter]
    public int consultationId { get; set; }
    
    private Models.HealthRecord HealthRecord { get; set; } = new Models.HealthRecord();
    private bool IsLoading { get; set; } = true;
    private bool IsSaving { get; set; } = false;
    private string ErrorMessage { get; set; } = "";
    
    protected override async Task OnParametersSetAsync()
    {
        await LoadHealthRecord();
    }
    
    private async Task LoadHealthRecord()
    {
        try
        {
            IsLoading = true;
            ErrorMessage = "";
            StateHasChanged();
            
            HealthRecord = await DbContext.HealthRecords
                .Include(c => c.Patient)
                .FirstOrDefaultAsync(c => c.RecordId == consultationId) ?? new Models.HealthRecord();
                
            if (HealthRecord == null)
            {
                ErrorMessage = "HealthRecord not found.";
                await JsRuntime.InvokeVoidAsync("alert", ErrorMessage);
                Navigation.NavigateTo("/doctor-health-records");
                return;
            }
            
            // Initialize new properties if they are null (for backward compatibility)
            if (HealthRecord.DoctorInitialRemarks == null)
                HealthRecord.DoctorInitialRemarks = "";
            if (HealthRecord.SpecialInstructions == null)
                HealthRecord.SpecialInstructions = "";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading consultation: {ex.Message}";
            await JsRuntime.InvokeVoidAsync("alert", ErrorMessage);
            Navigation.NavigateTo("/doctor-health-records");
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task UpdateHealthRecord()
    {
        try
        {
            IsSaving = true;
            ErrorMessage = "";
            
            // Validate required fields
            if (string.IsNullOrWhiteSpace(HealthRecord.AssessmentDiagnosis))
            {
                ErrorMessage = "Assessment/Diagnosis is required.";
                await JsRuntime.InvokeVoidAsync("alert", ErrorMessage);
                return;
            }
            
            // HealthRecord doesn't have UpdatedAt property, so we skip setting it
            
            DbContext.HealthRecords.Update(HealthRecord);
            await DbContext.SaveChangesAsync();
            
            await JsRuntime.InvokeVoidAsync("alert", "HealthRecord updated successfully!");
            Navigation.NavigateTo("/doctor-health-records");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error updating consultation: {ex.Message}";
            await JsRuntime.InvokeVoidAsync("alert", ErrorMessage);
        }
        finally
        {
            IsSaving = false;
        }
    }
    
    private void GoBack()
    {
        Navigation.NavigateTo("/doctor-health-records");
    }
}










