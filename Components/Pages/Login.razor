@page "/"
@page "/login"
@layout Layout.EmptyLayout
@using IT_13FinalProject.Services

<!-- ===================== OVERALL PAGE WRAPPER ===================== -->
<div class="login-page">

    <!-- ===================== MAIN CONTENT CONTAINER ===================== -->
    <div class="login-container">

        <!-- ===================== LEFT: LOGIN CARD ===================== -->
        <div class="login-card">

            <!-- Inner wrapper so we can center everything inside the white panel -->
            <div class="login-card-inner">

                <!-- ========== LOGO AREA ========== -->
                <div class="logo-placeholder">
                    <img src="/images/Final_logo-removebg-preview.png" alt="MedicationFlow Logo" class="logo-image" />
                </div>

                <!-- ========== LOGIN TITLE ========== -->
                <h2 class="login-title">Sign in to MedicationFlow</h2>

                <!-- ========== ERROR MESSAGE AREA ========== -->
                <!-- Shown when the entered credentials are incorrect -->
                @if (!string.IsNullOrWhiteSpace(ErrorMessage))
                {
                    <div class="login-error-message">@ErrorMessage</div>
                }

                <!-- ========== LOGIN FORM ========== -->
                <EditForm Model="this" OnValidSubmit="HandleLogin">
                    <DataAnnotationsValidator />

                    <!-- ----- USERNAME / EMAIL INPUT ROW ----- -->
                    <div class="input-group">
                        <!-- Input control for username/email -->
                        <input class="input-field" @bind="UserName" placeholder="Username or Email" />

                        <!-- Icon inside the pill input -->
                        <span class="input-icon input-icon-user"></span>
                    </div>

                    <!-- ----- PASSWORD INPUT ROW ----- -->
                    <div class="input-group">
                        <!-- Input control for password -->
                        <input class="input-field" @bind="Password" type="password" placeholder="Password" />

                        <!-- Lock icon inside the pill input -->
                        <span class="input-icon input-icon-lock"></span>
                    </div>

                    <!-- ========== LOGIN BUTTON ========== -->
                    <button type="submit" class="login-button" disabled="@IsSubmitting">
                        @if (IsSubmitting)
                        {
                            <span>Signing in...</span>
                        }
                        else
                        {
                            <span>LOGIN</span>
                        }
                    </button>
                </EditForm>

                <!-- ========== EXTRA LINKS AREA ========== -->
                <div class="login-links">
                    <a href="/forgot-password" class="login-link">Forgot your password?</a>
                </div>

                <!-- ========== FOOTER TEXT ========== -->
                <div class="login-footer-text">
                    <span>Terms of Use.</span>
                    <span>Privacy Policy.</span>
                </div>
            </div>
        </div>

        <!-- ===================== RIGHT: INFORMATION PANEL ===================== -->
        <div class="info-panel">

            <!-- Inner wrapper so we can center the text nicely in the green panel -->
            <div class="info-panel-inner">
                <!-- Big heading text, matching the design -->
                <h1 class="info-title">Integrated Clinical and Revenue Cycle Management System</h1>

                <!-- Description paragraph under the main title -->
                <p class="info-description">
                    MedicationFlow brings healthcare and transactions together in one smooth experience. Manage patient care,
                    records, and payments with just a few clicks.
                </p>
            </div>
        </div>
    </div>
</div>

@code {
    // ===================== BACKING FIELDS / PROPERTIES =====================
    // Property bound to the username/email input
    public string? UserName { get; set; }

    // Property bound to the password input
    public string? Password { get; set; }

    // Holds a message when login fails (kept if you want to show inline text later)
    public string? ErrorMessage { get; set; }

    // Loading state to prevent multiple submissions and provide feedback
    private bool IsSubmitting { get; set; } = false;

    [Inject]
    private NavigationManager Navigation { get; set; } = default!;

    // JS runtime used to show simple alert dialogs (e.g., invalid credentials)
    [Inject]
    private IJSRuntime JsRuntime { get; set; } = default!;

    [Inject]
    private IUserAccountService UserAccountService { get; set; } = default!;

    // ===================== EVENT HANDLERS =====================
    // This method is called when the form is submitted successfully
    private async Task HandleLogin()
    {
        if (IsSubmitting) return; // Prevent multiple submissions
        
        IsSubmitting = true;
        StateHasChanged();
        
        try
        {
            // Clear any existing error message first
            ErrorMessage = null;

            // Use async database authentication
            var userFromService = await UserAccountService.AuthenticateUserAsync(UserName ?? string.Empty, Password ?? string.Empty);

            if (userFromService is not null)
            {
                if (string.Equals(userFromService.Role, "Admin", StringComparison.OrdinalIgnoreCase))
                {
                    Navigation.NavigateTo("/admin-dashboard");
                    return;
                }

                if (string.Equals(userFromService.Role, "Nurse", StringComparison.OrdinalIgnoreCase))
                {
                    Navigation.NavigateTo("/nurse-dashboard");
                    return;
                }

                if (string.Equals(userFromService.Role, "Doctor", StringComparison.OrdinalIgnoreCase))
                {
                    Navigation.NavigateTo("/doctor-dashboard");
                    return;
                }

                if (string.Equals(userFromService.Role, "Billing Staff", StringComparison.OrdinalIgnoreCase))
                {
                    Navigation.NavigateTo("/billing-dashboard");
                    return;
                }

                if (string.Equals(userFromService.Role, "Inventory Staff", StringComparison.OrdinalIgnoreCase))
                {
                    Navigation.NavigateTo("/inventory-dashboard");
                    return;
                }
            }

            // Fallback to hard-coded credentials for demo purposes
            var isAdmin = string.Equals(UserName, "Admin", StringComparison.OrdinalIgnoreCase)
                          && Password == "12345";

            var isNurse = string.Equals(UserName, "Nurse", StringComparison.OrdinalIgnoreCase)
                          && Password == "12345";

            var isDoctor = string.Equals(UserName, "Doctor", StringComparison.OrdinalIgnoreCase)
                           && Password == "12345";

            var isBilling = string.Equals(UserName, "Billing", StringComparison.OrdinalIgnoreCase)
                            && Password == "12345";

            var isInventory = string.Equals(UserName, "Inventory", StringComparison.OrdinalIgnoreCase)
                               && Password == "12345";

            if (isAdmin)
            {
                Navigation.NavigateTo("/admin-dashboard");
                return;
            }

            if (isNurse)
            {
                Navigation.NavigateTo("/nurse-dashboard");
                return;
            }

            if (isDoctor)
            {
                Navigation.NavigateTo("/doctor-dashboard");
                return;
            }

            if (isBilling)
            {
                Navigation.NavigateTo("/billing-dashboard");
                return;
            }

            if (isInventory)
            {
                Navigation.NavigateTo("/inventory-dashboard");
                return;
            }

            // Show a simple dialog when credentials are invalid
            await JsRuntime.InvokeVoidAsync("alert", "Invalid Credentials!");
        }
        catch (Exception ex)
        {
            // Handle database errors gracefully
            await JsRuntime.InvokeVoidAsync("alert", $"Login error: {ex.Message}");
        }
        finally
        {
            IsSubmitting = false;
            StateHasChanged();
        }
    }
}










