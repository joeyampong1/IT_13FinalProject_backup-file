@page "/nurse-vitals-list"
@layout Layout.DashboardLayout
@using IT_13FinalProject.Models
@using IT_13FinalProject.Data
@using Microsoft.EntityFrameworkCore

@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject IJSRuntime JsRuntime

<div class="nv-page">
    <header class="dashboard-header">
        <div>
            <h1 class="dashboard-title">Patient Management</h1>
            <p class="dashboard-subtitle">Vital Signs Records</p>
        </div>

        <div class="dashboard-user-info">
            <span class="dashboard-user-email">nurse@gmail.com</span>
            <div class="dashboard-user-avatar">ðŸ‘¤</div>
            <span class="dashboard-user-name">Clinical</span>
        </div>
    </header>

    <div class="pm-overview-header">
        <div>
            <h2 class="pm-section-title">ðŸ“‹ Vital Signs Records</h2>
        </div>
        <div class="pm-actions">
            <label class="pm-toggle-container">
                <input type="checkbox" @onchange="OnToggleArchived" />
                <span class="pm-toggle-label">Show Archived</span>
            </label>
        </div>
    </div>

    <div class="pm-filters-row">
        <div class="pm-tab-container">
            <button class="pm-tab-btn @(!ShowArchived ? "active" : "")" @onclick="() => SetArchivedTab(false)">Active Records</button>
            <button class="pm-tab-btn @(ShowArchived ? "active" : "")" @onclick="() => SetArchivedTab(true)">Archived Records</button>
        </div>
        <div class="pm-search-row">
            <div class="pm-search-box">
                <div class="pm-search-icon"></div>
                <input class="pm-search-input" placeholder="Search Patient" />
            </div>

            <div class="pm-actions">
                <button class="activity-action-btn">Sort</button>
                <button class="activity-action-btn">Filters</button>
            </div>
        </div>
    </div>

    <section class="pm-overview">
        <div class="pm-table-outer">
            <div class="pm-table-wrapper">
                <table class="pm-table">
                    <thead>
                        <tr>
                            <th class="pm-col-id">ID</th>
                            <th>Patient Name<br /><span class="pm-subcol">Email</span></th>
                            <th>Assessment Status</th>
                            <th class="pm-col-date">Date of Visit</th>
                            <th class="pm-col-status">Vital Status</th>
                            <th class="pm-col-monitoring">Vital Signs Monitoring info</th>
                            <th class="pm-col-action">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (IsLoading)
                        {
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">
                                    <div>Loading vital signs...</div>
                                </td>
                            </tr>
                        }
                        else if (!string.IsNullOrEmpty(ErrorMessage))
                        {
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">
                                    <div style="color: red;">Error: @ErrorMessage</div>
                                    <button class="pm-back-btn" @onclick="LoadVitalSigns" style="margin-top: 1rem;">Retry</button>
                                </td>
                            </tr>
                        }
                        else if (VitalSigns.Count == 0)
                        {
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">
                                    <div>No vital sign records found.</div>
                                    @if (!ShowArchived)
                                    {
                                        <div style="margin-top: 1rem;">
                                            <button class="pm-add-vitals-btn" @onclick="GoToVitalsForm">
                                                <span>+ Add Vital Signs</span>
                                            </button>
                                        </div>
                                    }
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var vs in VitalSigns)
                            {
                                <tr class="@(vs.IsArchived ? "archived" : "")">
                                    <td class="pm-col-id">@vs.VitalSignId</td>
                                    <td>
                                        <div class="pm-patient-name">@(vs.Patient?.FirstName + " " + vs.Patient?.LastName ?? "Unknown")</div>
                                        <div class="pm-patient-email">@(vs.Patient?.Email ?? "No email")</div>
                                        @if (vs.IsArchived)
                                        {
                                            <span class="archived-indicator">ARCHIVED</span>
                                        }
                                    </td>
                                    <td>@(vs.ChiefComplaint?.Length > 0 ? "With Complaint" : "Routine Check")</td>
                                    <td class="pm-col-date">@vs.RecordedDate.ToString("MM/dd/yyyy")</td>
                                    <td class="pm-col-status">@(vs.BloodPressure?.Length > 0 ? "Complete" : "Partial")</td>
                                    <td class="pm-col-monitoring">
                                        <button class="pm-view-btn" @onclick="() => ViewVitals(vs)" aria-label="View vital signs record">
                                            <span class="pm-view-icon"></span>
                                            <span class="pm-btn-text">View</span>
                                        </button>
                                    </td>
                                    <td class="pm-col-action">
                                        @if (vs.IsArchived)
                                        {
                                            <button class="pm-restore-btn" @onclick="() => ArchiveVitals(vs)" aria-label="Restore vital signs record">
                                                <span class="pm-restore-icon"></span>
                                            </button>
                                            <button class="pm-delete-btn" @onclick="() => DeleteVitals(vs)" aria-label="Delete vital signs record permanently">
                                                <span class="pm-delete-icon"></span>
                                            </button>
                                        }
                                        else
                                        {
                                            <button class="pm-edit-btn" @onclick="() => EditVitals(vs)" title="Edit" aria-label="Edit vital signs record">
                                                <span class="pm-edit-icon"></span>
                                            </button>
                                            <button class="pm-archive-btn" @onclick="() => ArchiveVitals(vs)" title="Archive" aria-label="Archive vital signs record">
                                                <span class="pm-archive-icon"></span>
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="pm-pagination">
            <button class="pm-page-btn">Previous</button>
            <button class="pm-page-number active">1</button>
            <button class="pm-page-number">2</button>
            <button class="pm-page-number">3</button>
            <span class="pm-page-dots">...</span>
            <button class="pm-page-number">8</button>
            <button class="pm-page-btn">Next</button>
        </div>
    </section>

    @if (ShowViewModal)
    {
        <div class="nv-modal-overlay" @onclick="CloseViewModal">
            <div class="nv-modal" @onclick:stopPropagation="true">
                <div class="nv-modal-header">
                    <h2 class="nv-modal-title">View Vital Signs Record</h2>
                    <div class="nv-modal-subtitle">@(SelectedVitalSign.Patient?.FirstName + " " + SelectedVitalSign.Patient?.LastName ?? "Unknown")</div>
                </div>

                <div class="nv-modal-body">
                    <div class="nv-modal-grid">
                        <div class="nv-modal-col">
                            <h3 class="nv-modal-section-title">Medical History</h3>
                            <div class="nv-modal-row"><span class="nv-modal-label">Allergies</span><span class="nv-modal-value">@(SelectedVitalSign.Allergies ?? "N/A")</span></div>
                            <div class="nv-modal-row"><span class="nv-modal-label">Past Illnesses</span><span class="nv-modal-value">@(SelectedVitalSign.PastIllnesses ?? "N/A")</span></div>
                            <div class="nv-modal-row"><span class="nv-modal-label">Current Medications</span><span class="nv-modal-value">@(SelectedVitalSign.CurrentMedications ?? "N/A")</span></div>
                            <div class="nv-modal-row"><span class="nv-modal-label">Family History</span><span class="nv-modal-value">@(SelectedVitalSign.FamilyHistory ?? "N/A")</span></div>
                        </div>

                        <div class="nv-modal-col">
                            <h3 class="nv-modal-section-title">Vital Signs</h3>
                            <div class="nv-modal-row"><span class="nv-modal-label">Blood Pressure</span><span class="nv-modal-value">@(SelectedVitalSign.BloodPressure ?? "N/A")</span></div>
                            <div class="nv-modal-row"><span class="nv-modal-label">Heart Rate</span><span class="nv-modal-value">@(SelectedVitalSign.HeartRate?.ToString() ?? "N/A")</span></div>
                            <div class="nv-modal-row"><span class="nv-modal-label">Temperature</span><span class="nv-modal-value">@(SelectedVitalSign.Temperature?.ToString() ?? "N/A")</span></div>
                            <div class="nv-modal-row"><span class="nv-modal-label">Weight</span><span class="nv-modal-value">@(SelectedVitalSign.Weight?.ToString() ?? "N/A")</span></div>
                            <div class="nv-modal-row"><span class="nv-modal-label">Height</span><span class="nv-modal-value">@(SelectedVitalSign.Height?.ToString() ?? "N/A")</span></div>
                        </div>

                        <div class="nv-modal-col">
                            <h3 class="nv-modal-section-title">Current Visit Details</h3>
                            <div class="nv-modal-row"><span class="nv-modal-label">Doctor Assisted</span><span class="nv-modal-value">@(SelectedVitalSign.DoctorAssisted ?? "N/A")</span></div>
                            <div class="nv-modal-row"><span class="nv-modal-label">Nurse Name</span><span class="nv-modal-value">@(SelectedVitalSign.NurseName ?? "N/A")</span></div>
                            <div class="nv-modal-row"><span class="nv-modal-label">Date of Visit</span><span class="nv-modal-value">@SelectedVitalSign.RecordedDate.ToString("MM/dd/yyyy")</span></div>
                            <div class="nv-modal-row"><span class="nv-modal-label">Time In/out</span><span class="nv-modal-value">@(string.IsNullOrWhiteSpace(SelectedVitalSign.TimeInOut) ? "N/A" : SelectedVitalSign.TimeInOut)</span></div>
                            <div class="nv-modal-row"><span class="nv-modal-label">Department</span><span class="nv-modal-value">@(SelectedVitalSign.Department ?? "N/A")</span></div>
                            <div class="nv-modal-row"><span class="nv-modal-label">Type of Visit</span><span class="nv-modal-value">@(SelectedVitalSign.TypeOfVisit ?? "N/A")</span></div>
                            <div class="nv-modal-row"><span class="nv-modal-label">Chief Complaint</span><span class="nv-modal-value">@(SelectedVitalSign.ChiefComplaint ?? "N/A")</span></div>
                            <div class="nv-modal-row"><span class="nv-modal-label">Duration of Symptoms</span><span class="nv-modal-value">@(SelectedVitalSign.DurationSymptoms ?? "N/A")</span></div>
                        </div>

                        <div class="nv-modal-col nv-modal-col-notes @(IsNotesExpanded ? "expanded" : "collapsed")">
                            <div class="nv-modal-notes-header">
                                <h3 class="nv-modal-section-title" style="margin: 0;">Nursing Notes</h3>
                                <span class="nv-notes-toggle" role="button" tabindex="0" @onclick="ToggleNotesPanel">
                                    @(IsNotesExpanded ? "Collapse" : "Expand")
                                </span>
                            </div>
                            <div class="nv-notes-box">
                                @(string.IsNullOrWhiteSpace(SelectedVitalSign.Remarks) ? "N/A" : SelectedVitalSign.Remarks)
                            </div>
                        </div>
                    </div>
                </div>

                <div class="nv-modal-footer">
                    <button type="button" class="nv-modal-close-btn" @onclick="CloseViewModal">Close</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<VitalSign> VitalSigns = new();
    private bool IsLoading = true;
    private string ErrorMessage = "";
    private bool ShowArchived = false;

    private bool ShowViewModal = false;
    private VitalSign SelectedVitalSign = new();
    private bool IsNotesExpanded = false;
    
    private readonly char[] Alphabet =
        "ABCDEFGHIJKLMNOPQRSTUVWXYZ".ToCharArray();

    protected override async Task OnInitializedAsync()
    {
        await LoadVitalSigns();
    }

    private async Task LoadVitalSigns()
    {
        try
        {
            IsLoading = true;
            ErrorMessage = "";
            StateHasChanged();

            // Load vital signs based on ShowArchived tab
            if (ShowArchived)
            {
                // Archived Records tab: show archived only
                VitalSigns = await DbContext.VitalSigns
                    .Include(vs => vs.Patient)
                    .Where(vs => vs.IsArchived)
                    .OrderByDescending(vs => vs.RecordedDate)
                    .ToListAsync();
            }
            else
            {
                // Active Records tab: show non-archived only
                VitalSigns = await DbContext.VitalSigns
                    .Include(vs => vs.Patient)
                    .Where(vs => !vs.IsArchived)
                    .OrderByDescending(vs => vs.RecordedDate)
                    .ToListAsync();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading vital signs: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            ErrorMessage = $"Error loading vital signs: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnToggleArchived(ChangeEventArgs e)
    {
        ShowArchived = e.Value is bool b && b;
        await LoadVitalSigns();
    }

    private async Task SetArchivedTab(bool showArchived)
    {
        ShowArchived = showArchived;
        await LoadVitalSigns();
    }

    private void ViewVitals(VitalSign vitalSign)
    {
        SelectedVitalSign = vitalSign;
        ShowViewModal = true;
    }

    private void CloseViewModal()
    {
        ShowViewModal = false;
        SelectedVitalSign = new();
        IsNotesExpanded = false;
    }

    private void ToggleNotesPanel()
    {
        IsNotesExpanded = !IsNotesExpanded;
    }

    private void EditVitals(VitalSign vitalSign)
    {
        // Navigate to edit form
        Navigation.NavigateTo($"/nurse-vitals-edit/{vitalSign.VitalSignId}");
    }

    private async Task ArchiveVitals(VitalSign vitalSign)
    {
        try
        {
            string action = vitalSign.IsArchived ? "restore" : "archive";
            if (await JsRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to {action} this vital signs record?"))
            {
                if (vitalSign.IsArchived)
                {
                    // Restore the record
                    vitalSign.IsArchived = false;
                    vitalSign.ArchivedAt = null;
                    await JsRuntime.InvokeVoidAsync("alert", "Vital signs record restored successfully!");
                }
                else
                {
                    // Archive the record
                    vitalSign.IsArchived = true;
                    vitalSign.ArchivedAt = DateTime.UtcNow;
                    await JsRuntime.InvokeVoidAsync("alert", "Vital signs record archived successfully!");
                }
                
                vitalSign.UpdatedAt = DateTime.UtcNow;
                
                DbContext.VitalSigns.Update(vitalSign);
                await DbContext.SaveChangesAsync();
                
                await LoadVitalSigns(); // Refresh the list
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error archiving/restoring vital signs: {ex.Message}");
            await JsRuntime.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
    }

    private async Task DeleteVitals(VitalSign vitalSign)
    {
        try
        {
            if (await JsRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to permanently delete this vital signs record? This action cannot be undone!"))
            {
                DbContext.VitalSigns.Remove(vitalSign);
                await DbContext.SaveChangesAsync();
                
                await JsRuntime.InvokeVoidAsync("alert", "Vital signs record deleted permanently!");
                await LoadVitalSigns(); // Refresh the list
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting vital signs: {ex.Message}");
            await JsRuntime.InvokeVoidAsync("alert", $"Error deleting vital signs: {ex.Message}");
        }
    }

    private void GoToVitalsForm()
    {
        Navigation.NavigateTo("/nurse-vitals");
    }

    private IEnumerable<VitalSign> GetOrderedRows(char letter)
    {
        if (string.IsNullOrEmpty(letter.ToString()))
        {
            return VitalSigns;
        }

        var upper = letter.ToString().ToUpper();

        var startsWithLetter = VitalSigns
            .Where(r => (r.Patient?.FirstName + " " + r.Patient?.LastName ?? string.Empty)
                .StartsWith(upper, StringComparison.OrdinalIgnoreCase));

        var others = VitalSigns
            .Where(r => !(r.Patient?.FirstName + " " + r.Patient?.LastName ?? string.Empty)
                .StartsWith(upper, StringComparison.OrdinalIgnoreCase));

        return startsWithLetter.Concat(others);
    }
}






