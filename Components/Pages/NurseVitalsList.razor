@page "/nurse-vitals-list"
@layout Layout.DashboardLayout
@using IT_13FinalProject.Models
@using IT_13FinalProject.Data
@using Microsoft.EntityFrameworkCore

@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject IJSRuntime JsRuntime

<div class="nv-page">
    <header class="dashboard-header">
        <div>
            <h1 class="dashboard-title">Patient Management</h1>
            <p class="dashboard-subtitle">Vital Signs Records</p>
        </div>

        <div class="dashboard-user-info">
            <span class="dashboard-user-email">nurse@gmail.com</span>
            <div class="dashboard-user-avatar">ðŸ‘¤</div>
            <span class="dashboard-user-name">Clinical</span>
        </div>
    </header>

    <div class="pm-overview-header">
        <div>
            <h2 class="pm-section-title">ðŸ“‹ Vital Signs Records</h2>
        </div>
        <div class="pm-actions">
            <label class="pm-toggle-container">
                <input type="checkbox" @onchange="OnToggleArchived" />
                <span class="pm-toggle-label">Show Archived</span>
            </label>
        </div>
    </div>

    <div class="pm-filters-row">
        <div class="pm-search-row">
            <div class="pm-search-box">
                <div class="pm-search-icon"></div>
                <input class="pm-search-input" placeholder="Search Patient" />
            </div>

            <div class="pm-actions">
                <button class="activity-action-btn">Sort</button>
                <button class="activity-action-btn">Filters</button>
            </div>
        </div>
    </div>

    <section class="pm-overview">
        <div class="pm-table-outer">
            <div class="pm-table-wrapper">
                <table class="pm-table">
                    <thead>
                        <tr>
                            <th class="pm-col-id">ID</th>
                            <th>Patient Name<br /><span class="pm-subcol">Email</span></th>
                            <th>Assessment Status</th>
                            <th class="pm-col-date">Date of Visit</th>
                            <th class="pm-col-status">Vital Status</th>
                            <th class="pm-col-monitoring">Vital Signs Monitoring info</th>
                            <th class="pm-col-action">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (IsLoading)
                        {
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">
                                    <div>Loading vital signs...</div>
                                </td>
                            </tr>
                        }
                        else if (!string.IsNullOrEmpty(ErrorMessage))
                        {
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">
                                    <div style="color: red;">Error: @ErrorMessage</div>
                                    <button class="pm-back-btn" @onclick="LoadVitalSigns" style="margin-top: 1rem;">Retry</button>
                                </td>
                            </tr>
                        }
                        else if (VitalSigns.Count == 0)
                        {
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">
                                    <div>No vital sign records found.</div>
                                    <div style="margin-top: 1rem;">
                                        <button class="pm-add-vitals-btn" @onclick="GoToVitalsForm">
                                            <span>+ Add Vital Signs</span>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var vs in VitalSigns)
                            {
                                <tr class="@(vs.IsArchived ? "archived" : "")">
                                    <td class="pm-col-id">@vs.VitalSignId</td>
                                    <td>
                                        <div class="pm-patient-name">@(vs.Patient?.FirstName + " " + vs.Patient?.LastName ?? "Unknown")</div>
                                        <div class="pm-patient-email">@(vs.Patient?.Email ?? "No email")</div>
                                        @if (vs.IsArchived)
                                        {
                                            <span class="archived-indicator">ARCHIVED</span>
                                        }
                                    </td>
                                    <td>@(vs.ChiefComplaint?.Length > 0 ? "With Complaint" : "Routine Check")</td>
                                    <td class="pm-col-date">@vs.RecordedDate.ToString("MM/dd/yyyy")</td>
                                    <td class="pm-col-status">@(vs.BloodPressure?.Length > 0 ? "Complete" : "Partial")</td>
                                    <td class="pm-col-monitoring">
                                        <button class="pm-view-btn" @onclick="() => ViewVitals(vs)" aria-label="View vital signs record">
                                            <span class="pm-view-icon"></span>
                                            <span class="pm-btn-text">View</span>
                                        </button>
                                    </td>
                                    <td class="pm-col-action">
                                        @if (vs.IsArchived)
                                        {
                                            <button class="pm-restore-btn" @onclick="() => ArchiveVitals(vs)" aria-label="Restore vital signs record">
                                                <span class="pm-restore-icon"></span>
                                                <span class="pm-btn-text">Restore</span>
                                            </button>
                                            <button class="pm-delete-btn" @onclick="() => DeleteVitals(vs)" aria-label="Delete vital signs record permanently">
                                                <span class="pm-delete-icon"></span>
                                                <span class="pm-btn-text">Delete</span>
                                            </button>
                                        }
                                        else
                                        {
                                            <button class="pm-edit-btn" @onclick="() => EditVitals(vs)" aria-label="Edit vital signs record">
                                                <span class="pm-edit-icon"></span>
                                                <span class="pm-btn-text">Edit</span>
                                            </button>
                                            <button class="pm-archive-btn" @onclick="() => ArchiveVitals(vs)" aria-label="Archive vital signs record">
                                                <span class="pm-archive-icon"></span>
                                                <span class="pm-btn-text">Archive</span>
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <button type="button" class="pm-pagination-toggle" @onclick="TogglePagination" aria-label="Hide or show page buttons">
            <span>@(ShowPagination ? "â€º" : "â€¹")</span>
        </button>

        @if (ShowPagination)
        {
            <div class="pm-pagination">
                <button class="pm-page-btn">Previous</button>
                <button class="pm-page-number active">1</button>
                <button class="pm-page-number">2</button>
                <button class="pm-page-number">3</button>
                <span class="pm-page-dots">...</span>
                <button class="pm-page-number">8</button>
                <button class="pm-page-btn">Next</button>
            </div>
        }
    </section>
</div>

@code {
    private List<VitalSign> VitalSigns = new();
    private bool IsLoading = true;
    private string ErrorMessage = "";
    private bool ShowPagination = true;
    private bool ShowArchived = false;
    
    private readonly char[] Alphabet =
        "ABCDEFGHIJKLMNOPQRSTUVWXYZ".ToCharArray();

    protected override async Task OnInitializedAsync()
    {
        await LoadVitalSigns();
    }

    private async Task LoadVitalSigns()
    {
        try
        {
            IsLoading = true;
            ErrorMessage = "";
            StateHasChanged();

            // Load vital signs based on ShowArchived toggle
            if (ShowArchived)
            {
                // Show all records (both active and archived)
                VitalSigns = await DbContext.VitalSigns
                    .Include(vs => vs.Patient)
                    .OrderByDescending(vs => vs.RecordedDate)
                    .ToListAsync();
            }
            else
            {
                // Show only active (non-archived) records
                VitalSigns = await DbContext.VitalSigns
                    .Include(vs => vs.Patient)
                    .Where(vs => !vs.IsArchived)
                    .OrderByDescending(vs => vs.RecordedDate)
                    .ToListAsync();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading vital signs: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            ErrorMessage = $"Error loading vital signs: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnToggleArchived(ChangeEventArgs e)
    {
        ShowArchived = (bool)e.Value;
        await LoadVitalSigns();
    }

    private void ViewVitals(VitalSign vitalSign)
    {
        // Navigate to vital signs details view
        Navigation.NavigateTo($"/nurse-vitals-view/{vitalSign.VitalSignId}");
    }

    private void EditVitals(VitalSign vitalSign)
    {
        // Navigate to edit form
        Navigation.NavigateTo($"/nurse-vitals-edit/{vitalSign.VitalSignId}");
    }

    private async Task ArchiveVitals(VitalSign vitalSign)
    {
        try
        {
            string action = vitalSign.IsArchived ? "restore" : "archive";
            if (await JsRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to {action} this vital signs record?"))
            {
                if (vitalSign.IsArchived)
                {
                    // Restore the record
                    vitalSign.IsArchived = false;
                    vitalSign.ArchivedAt = null;
                    await JsRuntime.InvokeVoidAsync("alert", "Vital signs record restored successfully!");
                }
                else
                {
                    // Archive the record
                    vitalSign.IsArchived = true;
                    vitalSign.ArchivedAt = DateTime.UtcNow;
                    await JsRuntime.InvokeVoidAsync("alert", "Vital signs record archived successfully!");
                }
                
                vitalSign.UpdatedAt = DateTime.UtcNow;
                
                DbContext.VitalSigns.Update(vitalSign);
                await DbContext.SaveChangesAsync();
                
                await LoadVitalSigns(); // Refresh the list
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error archiving/restoring vital signs: {ex.Message}");
            await JsRuntime.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
    }

    private async Task DeleteVitals(VitalSign vitalSign)
    {
        try
        {
            if (await JsRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to permanently delete this vital signs record? This action cannot be undone!"))
            {
                DbContext.VitalSigns.Remove(vitalSign);
                await DbContext.SaveChangesAsync();
                
                await JsRuntime.InvokeVoidAsync("alert", "Vital signs record deleted permanently!");
                await LoadVitalSigns(); // Refresh the list
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting vital signs: {ex.Message}");
            await JsRuntime.InvokeVoidAsync("alert", $"Error deleting vital signs: {ex.Message}");
        }
    }

    private void GoToVitalsForm()
    {
        Navigation.NavigateTo("/nurse-vitals");
    }

    private void TogglePagination()
    {
        ShowPagination = !ShowPagination;
    }

    private IEnumerable<VitalSign> GetOrderedRows(char letter)
    {
        if (string.IsNullOrEmpty(letter.ToString()))
        {
            return VitalSigns;
        }

        var upper = letter.ToString().ToUpper();

        var startsWithLetter = VitalSigns
            .Where(r => (r.Patient?.FirstName + " " + r.Patient?.LastName ?? string.Empty)
                .StartsWith(upper, StringComparison.OrdinalIgnoreCase));

        var others = VitalSigns
            .Where(r => !(r.Patient?.FirstName + " " + r.Patient?.LastName ?? string.Empty)
                .StartsWith(upper, StringComparison.OrdinalIgnoreCase));

        return startsWithLetter.Concat(others);
    }
}






